<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste DeviceOrientationEvent</title>
</head>
<body>
  <h1>Teste Sensor de Movimento</h1>
  <button onclick="ativarSensores()">Ativar Sensor</button>
  <button onclick="calibrar()">Calibrar Mira</button>
  <pre id="output">Clique no bot√£o acima para ativar os sensores.</pre>

  <script>
    let socket;
    let referencia = null;

    function ativarSensores() {
      const output = document.getElementById("output");

      // Conex√£o WebSocket
      socket = new WebSocket('wss://192.168.147.188:3000'); // Altere para IP correto

      socket.onopen = () => {
        output.textContent = "‚úÖ Conectado ao WebSocket\n";
      };

      socket.onerror = (error) => {
        output.textContent += "‚ùå Erro na conex√£o WebSocket\n";
        console.error('Erro WebSocket:', error);
      };

      socket.onclose = () => {
        output.textContent += "‚ö†Ô∏è Conex√£o WebSocket encerrada\n";
      };

      // Verifica suporte
      if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
        // iOS (Safari)
        DeviceOrientationEvent.requestPermission()
          .then(permissionState => {
            if (permissionState === "granted") {
              ativarListener();
            } else {
              output.textContent += "‚ùå Permiss√£o negada para acessar sensores";
            }
          })
          .catch(console.error);
      } else if (typeof DeviceOrientationEvent !== "undefined") {
        // Android ou navegadores com permiss√£o autom√°tica
        ativarListener();
      } else {
        output.textContent += "‚ùå DeviceOrientationEvent N√ÉO SUPORTADO";
      }
    }

    function calibrar() {
      if (ultimoEvento) {
        referencia = {
          beta: ultimoEvento.beta,
          gamma: ultimoEvento.gamma
        };

        if ("vibrate" in navigator) {
          navigator.vibrate(200); // vibra por 200ms
          console.log("‚úÖ Vibra√ß√£o ativada na calibra√ß√£o");
        } else {
          console.log("‚ùå Vibra√ß√£o n√£o suportada no dispositivo");
          alert("üìå Mira calibrada!");
        }   
       
      }
    }

    let ultimoEvento = null;

    function ativarListener() {
      const output = document.getElementById("output");

      window.addEventListener("deviceorientation", function(event) {
        ultimoEvento = event;

        if (!referencia) {
          output.textContent = "‚ÑπÔ∏è Aponte para a TV e clique em Calibrar.";
          return;
        }

        const delta = {
          x: event.gamma - referencia.gamma, // lateral
          y: event.beta - referencia.beta    // vertical
        };

        output.textContent = `
        üéØ Posi√ß√£o relativa:
        x (gamma): ${delta.x.toFixed(2)}
        y (beta): ${delta.y.toFixed(2)}
        `;

        // Envia via WebSocket se conectado
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(delta));
        }
      });
    }
  </script>
</body>
</html>
